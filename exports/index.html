<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Security Operations Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg-dark: #050712;
      --bg-dark-card: #101325;
      --bg-light: #f4f6fb;
      --bg-light-card: #ffffff;

      --text-dark: #f9fbff;
      --text-light: #111827;

      --border-subtle-dark: #1f2937;
      --border-subtle-light: #d1d5db;

      --accent: #4f8cff;

      --sev-critical: #ef4444;
      --sev-high: #f97316;
      --sev-medium: #eab308;
      --sev-low: #22c55e;

      --status-green: #16a34a;
      --status-yellow: #eab308;
      --status-red: #ef4444;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    body.theme-dark {
      --bg: var(--bg-dark);
      --bg-card: var(--bg-dark-card);
      --text: var(--text-dark);
      --border-subtle: var(--border-subtle-dark);
    }

    body.theme-light {
      --bg: var(--bg-light);
      --bg-card: var(--bg-light-card);
      --text: var(--text-light);
      --border-subtle: var(--border-subtle-light);
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1.5rem;
      border-bottom: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .app-title {
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .app-status {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.875rem;
      opacity: 0.9;
    }

    .status-pill {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .status-green {
      background: rgba(22, 163, 74, 0.1);
      color: var(--status-green);
      border: 1px solid rgba(22, 163, 74, 0.4);
    }

    .status-yellow {
      background: rgba(234, 179, 8, 0.1);
      color: var(--status-yellow);
      border: 1px solid rgba(234, 179, 8, 0.4);
    }

    .status-red {
      background: rgba(239, 68, 68, 0.1);
      color: var(--status-red);
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .tab-bar {
      display: flex;
      padding: 0 1.5rem;
      gap: 0.5rem;
      border-bottom: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.85);
      position: sticky;
      top: 2.5rem;
      z-index: 40;
    }

    .tab {
      border: none;
      background: transparent;
      color: inherit;
      padding: 0.6rem 0.9rem;
      font-size: 0.875rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      opacity: 0.7;
    }

    .tab:hover {
      opacity: 1;
    }

    .tab.active {
      border-bottom-color: var(--accent);
      opacity: 1;
      font-weight: 500;
    }

    .tab-container {
      padding: 1.25rem 1.5rem 2rem;
      max-width: 1300px;
      margin: 0 auto;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .grid {
      display: grid;
      gap: 1rem;
    }

    .kpi-grid {
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      margin-bottom: 1rem;
    }

    .card {
      background: var(--bg-card);
      border-radius: 0.75rem;
      border: 1px solid var(--border-subtle);
      padding: 0.9rem 1rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      margin-bottom: 1rem;
    }

    .card h3 {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.6rem;
      flex-wrap: wrap;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      justify-content: flex-end;
      font-size: 0.8rem;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .filter-group label {
      opacity: 0.8;
    }

    .filter-group select,
    .filter-group input[type="text"] {
      font-size: 0.8rem;
      padding: 0.15rem 0.35rem;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.6);
      color: inherit;
    }

    body.theme-light .filter-group select,
    body.theme-light .filter-group input[type="text"] {
      background: #f9fafb;
    }

    .kpi {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .kpi-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.7;
    }

    .kpi-value {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .kpi-sub {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table.data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    table.data-table thead {
      background: rgba(148, 163, 184, 0.1);
    }

    table.data-table th,
    table.data-table td {
      padding: 0.4rem 0.5rem;
      border-bottom: 1px solid var(--border-subtle);
      white-space: nowrap;
    }

    table.data-table tbody tr {
      cursor: pointer;
      transition: background 0.15s ease;
    }

    table.data-table tbody tr:hover {
      background: rgba(148, 163, 184, 0.09);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 60px;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .sev-critical {
      background: rgba(239, 68, 68, 0.12);
      color: var(--sev-critical);
      border: 1px solid rgba(239, 68, 68, 0.6);
    }

    .sev-high {
      background: rgba(249, 115, 22, 0.12);
      color: var(--sev-high);
      border: 1px solid rgba(249, 115, 22, 0.6);
    }

    .sev-medium {
      background: rgba(234, 179, 8, 0.12);
      color: var(--sev-medium);
      border: 1px solid rgba(234, 179, 8, 0.6);
    }

    .sev-low {
      background: rgba(34, 197, 94, 0.12);
      color: var(--sev-low);
      border: 1px solid rgba(34, 197, 94, 0.6);
    }

    .status-pill-small {
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      opacity: 0.9;
    }

    .tab-notes {
      margin-top: 0.5rem;
    }

    .tab-notes textarea {
      width: 100%;
      min-height: 80px;
      padding: 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.6);
      color: inherit;
      resize: vertical;
      font-size: 0.85rem;
    }

    body.theme-light .tab-notes textarea {
      background: #f9fafb;
    }

    /* Drawer */

    .drawer {
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: 380px;
      max-width: 100%;
      background: var(--bg-card);
      border-left: 1px solid var(--border-subtle);
      box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
      transform: translateX(100%);
      transition: transform 0.25s ease-out;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .drawer.open {
      transform: translateX(0);
    }

    .drawer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.8rem 1rem;
      border-bottom: 1px solid var(--border-subtle);
    }

    .drawer-header h2 {
      margin: 0;
      font-size: 0.95rem;
    }

    .drawer-close-btn {
      border: none;
      background: transparent;
      color: inherit;
      font-size: 1.2rem;
      cursor: pointer;
      opacity: 0.7;
    }

    .drawer-close-btn:hover {
      opacity: 1;
    }

    .drawer-meta {
      padding: 0.5rem 1rem;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 0.8rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .drawer-meta span {
      opacity: 0.9;
    }

    .drawer-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-subtle);
    }

    .drawer-tab {
      flex: 1;
      padding: 0.4rem 0.6rem;
      border: none;
      background: transparent;
      color: inherit;
      font-size: 0.8rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      opacity: 0.7;
    }

    .drawer-tab.active {
      border-bottom-color: var(--accent);
      opacity: 1;
      font-weight: 500;
    }

    .drawer-body {
      padding: 0.7rem 1rem 1rem;
      overflow-y: auto;
      flex: 1;
      font-size: 0.85rem;
    }

    .drawer-panel {
      display: none;
    }

    .drawer-panel.active {
      display: block;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.35rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      border-bottom: 1px dashed rgba(148, 163, 184, 0.3);
      padding-bottom: 0.15rem;
    }

    .summary-label {
      opacity: 0.75;
    }

    .summary-value {
      text-align: right;
      font-weight: 500;
    }

    pre.fulltext {
      white-space: pre-wrap;
      background: rgba(15, 23, 42, 0.8);
      padding: 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border-subtle);
      max-height: 300px;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
    }

    body.theme-light pre.fulltext {
      background: #f9fafb;
    }

    .notes-list {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-bottom: 0.6rem;
    }

    .note-item {
      border-radius: 0.5rem;
      border: 1px solid var(--border-subtle);
      padding: 0.4rem 0.5rem;
      background: rgba(15, 23, 42, 0.7);
    }

    body.theme-light .note-item {
      background: #f9fafb;
    }

    .note-meta {
      font-size: 0.7rem;
      opacity: 0.75;
      margin-bottom: 0.2rem;
    }

    .note-text {
      font-size: 0.8rem;
      line-height: 1.3;
    }

    .note-new textarea {
      width: 100%;
      min-height: 60px;
      resize: vertical;
      border-radius: 0.4rem;
      border: 1px solid var(--border-subtle);
      padding: 0.4rem;
      background: rgba(15, 23, 42, 0.6);
      color: inherit;
      font-size: 0.8rem;
    }

    body.theme-light .note-new textarea {
      background: #f9fafb;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      color: inherit;
      padding: 0.3rem 0.9rem;
      font-size: 0.8rem;
      cursor: pointer;
    }

    body.theme-light .btn {
      background: #ffffff;
    }

    .btn-primary {
      border-color: rgba(79, 140, 255, 0.6);
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      filter: brightness(1.05);
    }

    .btn-danger {
      border-color: rgba(239, 68, 68, 0.7);
      background: rgba(239, 68, 68, 0.15);
      color: var(--sev-critical);
    }

    .btn-small {
      padding: 0.15rem 0.5rem;
      font-size: 0.75rem;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .settings-group {
      margin-bottom: 1rem;
    }

    .settings-group label {
      font-size: 0.85rem;
      display: block;
      margin-bottom: 0.25rem;
    }

    .settings-group input[type="text"] {
      width: 100%;
      padding: 0.35rem 0.5rem;
      border-radius: 0.4rem;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.6);
      color: inherit;
      font-size: 0.85rem;
    }

    body.theme-light .settings-group input[type="text"] {
      background: #f9fafb;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.85rem;
    }

    .toggle input[type="checkbox"] {
      width: 1.1rem;
      height: 1.1rem;
    }

    .add-form-grid {
      display: grid;
      gap: 0.4rem;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      margin-top: 0.5rem;
    }

    .add-form-grid label {
      font-size: 0.75rem;
      opacity: 0.8;
      display: block;
      margin-bottom: 0.1rem;
    }

    .add-form-grid input,
    .add-form-grid select,
    .add-form-grid textarea {
      width: 100%;
      box-sizing: border-box;
      font-size: 0.8rem;
      padding: 0.25rem 0.4rem;
      border-radius: 0.35rem;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.6);
      color: inherit;
    }

    body.theme-light .add-form-grid input,
    body.theme-light .add-form-grid select,
    body.theme-light .add-form-grid textarea {
      background: #f9fafb;
    }

    .add-form-actions {
      margin-top: 0.5rem;
      text-align: right;
    }

    @media (max-width: 768px) {
      .tab-container {
        padding: 0.75rem 0.75rem 1.5rem;
      }

      .drawer {
        width: 100%;
      }
    }
  </style>
</head>
<body class="theme-dark">
  <header class="app-header">
    <div class="app-title">Security Operations Dashboard</div>
    <div class="app-status">
      <span id="overall-status" class="status-pill status-green">Normal</span>
      <span id="clock"></span>
    </div>
  </header>

  <nav class="tab-bar">
    <button class="tab active" data-tab="overview">Overview</button>
    <button class="tab" data-tab="incidents">Incidents</button>
    <button class="tab" data-tab="alerts">Alerts</button>
    <button class="tab" data-tab="assets">Assets</button>
    <button class="tab" data-tab="settings">Settings</button>
  </nav>

  <main class="tab-container">
    <!-- OVERVIEW TAB -->
    <section id="tab-overview" class="tab-panel active">
      <div id="overview-kpis" class="grid kpi-grid"></div>

      <div class="card">
        <div class="card-header-row">
          <h3>Recent Alerts</h3>
        </div>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
            <tr>
              <th>ID</th>
              <th>Rule</th>
              <th>Severity</th>
              <th>Source</th>
              <th>Last Seen</th>
            </tr>
            </thead>
            <tbody id="overview-alerts-tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card tab-notes">
        <h3>Overview Notes</h3>
        <textarea class="tab-notes-input" data-tab="overview"
                  placeholder="Shift summary, todayâ€™s focus, etc."></textarea>
      </div>
    </section>

    <!-- INCIDENTS TAB -->
    <section id="tab-incidents" class="tab-panel">
      <div class="card">
        <div class="card-header-row">
          <h3>Incidents</h3>
          <div class="filters-row">
            <div class="filter-group">
              <label for="incident-filter-severity">Severity</label>
              <select id="incident-filter-severity">
                <option value="all">All</option>
                <option value="Critical">Critical</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="incident-filter-status">Status</label>
              <select id="incident-filter-status">
                <option value="all">All</option>
                <option value="New">New</option>
                <option value="In Progress">In Progress</option>
                <option value="Contained">Contained</option>
                <option value="Closed">Closed</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="incident-filter-search">Search</label>
              <input type="text" id="incident-filter-search" placeholder="ID, title, owner...">
            </div>
          </div>
        </div>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Severity</th>
              <th>Status</th>
              <th>Owner</th>
              <th>Source</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody id="incidents-tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header-row">
          <h3>Add Incident</h3>
        </div>
        <div class="add-form-grid">
          <div>
            <label for="add-incident-title">Title</label>
            <input id="add-incident-title" type="text" placeholder="Suspicious ...">
          </div>
          <div>
            <label for="add-incident-severity">Severity</label>
            <select id="add-incident-severity">
              <option value="High">High</option>
              <option value="Critical">Critical</option>
              <option value="Medium">Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div>
            <label for="add-incident-status">Status</label>
            <select id="add-incident-status">
              <option value="New">New</option>
              <option value="In Progress">In Progress</option>
              <option value="Contained">Contained</option>
              <option value="Closed">Closed</option>
            </select>
          </div>
          <div>
            <label for="add-incident-owner">Owner</label>
            <input id="add-incident-owner" type="text" placeholder="analyst.name">
          </div>
          <div>
            <label for="add-incident-source">Source</label>
            <input id="add-incident-source" type="text" placeholder="SIEM / EDR / ...">
          </div>
          <div style="grid-column: 1/-1;">
            <label for="add-incident-fulltext">Full Text</label>
            <textarea id="add-incident-fulltext" rows="3" placeholder="Incident description / context"></textarea>
          </div>
        </div>
        <div class="add-form-actions">
          <button id="add-incident-button" class="btn btn-primary btn-small">Add Incident</button>
        </div>
      </div>

      <div class="card tab-notes">
        <h3>Incidents Notes</h3>
        <textarea class="tab-notes-input" data-tab="incidents"
                  placeholder="Notes about incident triage, priorities, etc."></textarea>
      </div>
    </section>

    <!-- ALERTS TAB -->
    <section id="tab-alerts" class="tab-panel">
      <div class="card">
        <div class="card-header-row">
          <h3>Alerts</h3>
          <div class="filters-row">
            <div class="filter-group">
              <label for="alert-filter-severity">Severity</label>
              <select id="alert-filter-severity">
                <option value="all">All</option>
                <option value="Critical">Critical</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="alert-filter-status">Status</label>
              <select id="alert-filter-status">
                <option value="all">All</option>
                <option value="New">New</option>
                <option value="Escalated">Escalated</option>
                <option value="Suppressed">Suppressed</option>
                <option value="Closed">Closed</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="alert-filter-search">Search</label>
              <input type="text" id="alert-filter-search" placeholder="ID, rule, source...">
            </div>
          </div>
        </div>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
            <tr>
              <th>ID</th>
              <th>Rule</th>
              <th>Severity</th>
              <th>Status</th>
              <th>Source</th>
              <th>Asset</th>
              <th>Last Seen</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody id="alerts-tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header-row">
          <h3>Add Alert</h3>
        </div>
        <div class="add-form-grid">
          <div>
            <label for="add-alert-rule">Rule</label>
            <input id="add-alert-rule" type="text" placeholder="Detection name">
          </div>
          <div>
            <label for="add-alert-severity">Severity</label>
            <select id="add-alert-severity">
              <option value="High">High</option>
              <option value="Critical">Critical</option>
              <option value="Medium">Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div>
            <label for="add-alert-status">Status</label>
            <select id="add-alert-status">
              <option value="New">New</option>
              <option value="Escalated">Escalated</option>
              <option value="Suppressed">Suppressed</option>
              <option value="Closed">Closed</option>
            </select>
          </div>
          <div>
            <label for="add-alert-source">Source</label>
            <input id="add-alert-source" type="text" placeholder="SIEM / EDR / EmailSec">
          </div>
          <div>
            <label for="add-alert-asset">Asset ID</label>
            <input id="add-alert-asset" type="text" placeholder="ASSET-...">
          </div>
          <div style="grid-column: 1/-1;">
            <label for="add-alert-fulltext">Full Text</label>
            <textarea id="add-alert-fulltext" rows="3" placeholder="Alert body / log excerpt"></textarea>
          </div>
        </div>
        <div class="add-form-actions">
          <button id="add-alert-button" class="btn btn-primary btn-small">Add Alert</button>
        </div>
      </div>

      <div class="card tab-notes">
        <h3>Alerts Notes</h3>
        <textarea class="tab-notes-input" data-tab="alerts"
                  placeholder="Notes about noisy rules, tuning ideas, etc."></textarea>
      </div>
    </section>

    <!-- ASSETS TAB -->
    <section id="tab-assets" class="tab-panel">
      <div class="card">
        <div class="card-header-row">
          <h3>Assets</h3>
          <div class="filters-row">
            <div class="filter-group">
              <label for="asset-filter-criticality">Criticality</label>
              <select id="asset-filter-criticality">
                <option value="all">All</option>
                <option value="Critical">Critical</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="asset-filter-search">Search</label>
              <input type="text" id="asset-filter-search" placeholder="Hostname, IP, owner...">
            </div>
          </div>
        </div>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
            <tr>
              <th>ID</th>
              <th>Hostname</th>
              <th>IP</th>
              <th>Criticality</th>
              <th>Owner</th>
              <th>OS</th>
              <th>Last Seen</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody id="assets-tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header-row">
          <h3>Add Asset</h3>
        </div>
        <div class="add-form-grid">
          <div>
            <label for="add-asset-hostname">Hostname</label>
            <input id="add-asset-hostname" type="text" placeholder="HOST01.internal.local">
          </div>
          <div>
            <label for="add-asset-ip">IP</label>
            <input id="add-asset-ip" type="text" placeholder="10.0.0.x">
          </div>
          <div>
            <label for="add-asset-criticality">Criticality</label>
            <select id="add-asset-criticality">
              <option value="High">High</option>
              <option value="Critical">Critical</option>
              <option value="Medium">Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div>
            <label for="add-asset-owner">Owner</label>
            <input id="add-asset-owner" type="text" placeholder="Team / Person">
          </div>
          <div>
            <label for="add-asset-os">OS</label>
            <input id="add-asset-os" type="text" placeholder="Windows / Linux / ...">
          </div>
          <div style="grid-column: 1/-1;">
            <label for="add-asset-fulltext">Full Text</label>
            <textarea id="add-asset-fulltext" rows="3" placeholder="Business context, dependencies, etc."></textarea>
          </div>
        </div>
        <div class="add-form-actions">
          <button id="add-asset-button" class="btn btn-primary btn-small">Add Asset</button>
        </div>
      </div>

      <div class="card tab-notes">
        <h3>Assets Notes</h3>
        <textarea class="tab-notes-input" data-tab="assets"
                  placeholder="Context about crown jewels, maintenance windows, etc."></textarea>
      </div>
    </section>

    <!-- SETTINGS TAB -->
    <section id="tab-settings" class="tab-panel">
      <div class="card">
        <h3>Appearance</h3>
        <div class="settings-group">
          <label class="toggle">
            <input type="checkbox" id="theme-toggle" checked>
            <span>Use dark theme</span>
          </label>
        </div>
      </div>

      <div class="card">
        <h3>Analyst</h3>
        <div class="settings-group">
          <label for="analyst-name-input">Display name for notes</label>
          <input type="text" id="analyst-name-input" placeholder="Analyst">
        </div>
      </div>
    </section>
  </main>

  <!-- DETAIL DRAWER -->
  <aside id="detail-drawer" class="drawer">
    <div class="drawer-header">
      <h2 id="drawer-title"></h2>
      <button id="drawer-close" class="drawer-close-btn" aria-label="Close">&times;</button>
    </div>
    <div id="drawer-meta" class="drawer-meta"></div>
    <div class="drawer-tabs">
      <button class="drawer-tab active" data-dtab="summary">Summary</button>
      <button class="drawer-tab" data-dtab="fulltext">Full Text</button>
      <button class="drawer-tab" data-dtab="notes">Notes</button>
    </div>
    <div class="drawer-body">
      <div id="drawer-summary" class="drawer-panel active"></div>
      <div id="drawer-fulltext" class="drawer-panel"></div>
      <div id="drawer-notes" class="drawer-panel"></div>
    </div>
  </aside>

  <script>
    // --- Demo Data ----------------------------------------------------------
    const DemoData = {
      incidents: [
        {
          id: "INC-1023",
          title: "Suspicious PowerShell Activity on DC01",
          severity: "High",
          status: "In Progress",
          owner: "analyst.jane",
          source: "EDR",
          createdAt: "2025-11-13T09:02:00Z",
          updatedAt: "2025-11-13T10:15:00Z",
          tags: ["PowerShell", "EDR", "Lateral Movement"],
          relatedAlerts: ["ALRT-4432", "ALRT-4438"],
          fullText:
            "Incident INC-1023\n\nSummary:\nEDR detected suspicious PowerShell command execution on DC01.\n\nDetails:\n- Encoded PowerShell launched from Office macro.\n- Network connections to rare external IPs.\n- Mimikatz-like strings observed in memory.\n\nPlanned Actions:\n- Isolate host.\n- Collect memory image.\n- Reset domain admin credentials if compromise confirmed.",
          notes: []
        },
        {
          id: "INC-1024",
          title: "Multiple Failed Logons from Rare Country",
          severity: "Medium",
          status: "New",
          owner: "unassigned",
          source: "SIEM",
          createdAt: "2025-11-13T07:12:00Z",
          updatedAt: "2025-11-13T07:12:00Z",
          tags: ["Authentication", "Geo Anomaly"],
          relatedAlerts: ["ALRT-4440"],
          fullText:
            "SIEM use case 'Rare Country Logins' fired multiple times against user HR-USER-12.\n\nAuthentication attempts from IPs in a country not seen in the last 90 days.\n\nUser is normally office-based with no travel scheduled.",
          notes: []
        },
        {
          id: "INC-1025",
          title: "Possible Phishing Campaign via O365",
          severity: "Critical",
          status: "New",
          owner: "analyst.mike",
          source: "EmailSec",
          createdAt: "2025-11-13T06:45:00Z",
          updatedAt: "2025-11-13T06:50:00Z",
          tags: ["Phishing", "O365", "Credential Theft"],
          relatedAlerts: ["ALRT-4441", "ALRT-4442"],
          fullText:
            "Email security gateway detected multiple inbound messages with suspicious links imitating MFA prompts.\n\nTargets include finance and executive assistants.\nLanding pages observed collecting O365 credentials.\n\nBlocklist has been updated and retroactive search performed.",
          notes: []
        }
      ],
      alerts: [
        {
          id: "ALRT-4432",
          rule: "Suspicious PowerShell Command Line",
          severity: "High",
          status: "Escalated",
          source: "EDR",
          firstSeen: "2025-11-13T08:55:00Z",
          lastSeen: "2025-11-13T09:10:00Z",
          count: 12,
          assetId: "ASSET-01",
          incidentId: "INC-1023",
          fullText:
            "Alert: Suspicious PowerShell Command Line\n\nEDR telemetry:\n- Parent process: WINWORD.EXE\n- Command line: powershell.exe -enc <redacted>\n- User: CORP\\\\jdoe\n- MITRE: T1059 PowerShell\n\nRaw JSON payload omitted for brevity.",
          notes: []
        },
        {
          id: "ALRT-4438",
          rule: "Powershell DownloadFile from Rare Domain",
          severity: "High",
          status: "New",
          source: "EDR",
          firstSeen: "2025-11-13T09:05:00Z",
          lastSeen: "2025-11-13T09:06:00Z",
          count: 3,
          assetId: "ASSET-01",
          incidentId: "INC-1023",
          fullText:
            "Detected PowerShell WebClient DownloadFile to https://example-bad-domain[.]com from DC01.\n\nUser: CORP\\\\jdoe\n\nHTTP headers and payload recorded in EDR telemetry.",
          notes: []
        },
        {
          id: "ALRT-4440",
          rule: "Rare Country Logins",
          severity: "Medium",
          status: "New",
          source: "SIEM",
          firstSeen: "2025-11-13T07:05:00Z",
          lastSeen: "2025-11-13T07:10:00Z",
          count: 5,
          assetId: "ASSET-03",
          incidentId: "INC-1024",
          fullText:
            "Multiple authentication failures from IP 203.0.113.10 (Country X) against HR-USER-12.\n\nGeo profile: Country X not seen in last 90 days for this user or peer group.\n\nSource: VPN gateway logs normalized in SIEM.",
          notes: []
        },
        {
          id: "ALRT-4441",
          rule: "Inbound Email with Suspicious MFA Link",
          severity: "Critical",
          status: "Escalated",
          source: "EmailSec",
          firstSeen: "2025-11-13T06:40:00Z",
          lastSeen: "2025-11-13T06:42:00Z",
          count: 18,
          assetId: "ASSET-02",
          incidentId: "INC-1025",
          fullText:
            "EmailSubject: 'Action Required: Confirm Your MFA Settings'\n\nLinks redirect through multiple URL shorteners to a fake O365 login page.\n\nDetection engine score: 95/100 (phishing).",
          notes: []
        },
        {
          id: "ALRT-4442",
          rule: "User Clicked Phishing Link",
          severity: "Critical",
          status: "New",
          source: "EmailSec",
          firstSeen: "2025-11-13T06:46:00Z",
          lastSeen: "2025-11-13T06:46:00Z",
          count: 4,
          assetId: "ASSET-02",
          incidentId: "INC-1025",
          fullText:
            "Click telemetry indicates that four users followed the phishing link within 5 minutes of delivery.\n\nNo MFA prompt observed downstream; credential theft suspected.",
          notes: []
        }
      ],
      assets: [
        {
          id: "ASSET-01",
          hostname: "DC01.internal.local",
          ip: "10.0.0.10",
          owner: "IT Ops",
          department: "Infrastructure",
          criticality: "Critical",
          os: "Windows Server 2019",
          lastSeen: "2025-11-13T10:00:00Z",
          alertCount: 15,
          incidentCount: 1,
          tags: ["Domain Controller", "AD", "Tier0"],
          fullText:
            "Domain controller for INTERNAL domain.\nHosts AD DS, DNS, and DHCP.\nConsidered Tier 0 / crown jewel asset.\n\nChange control required for all reboots and patches.",
          notes: []
        },
        {
          id: "ASSET-02",
          hostname: "EXCH01.internal.local",
          ip: "10.0.0.20",
          owner: "Messaging",
          department: "IT",
          criticality: "High",
          os: "Windows Server 2016",
          lastSeen: "2025-11-13T09:45:00Z",
          alertCount: 8,
          incidentCount: 1,
          tags: ["Email", "O365 Hybrid"],
          fullText:
            "On-prem Exchange hybrid server.\nUsed for mail relay and coexistence with O365.\n\nAlerts here may indicate phishing campaigns or relay abuse.",
          notes: []
        },
        {
          id: "ASSET-03",
          hostname: "VPN-GW01.internal.local",
          ip: "10.0.0.30",
          owner: "Network",
          department: "Infrastructure",
          criticality: "High",
          os: "Linux",
          lastSeen: "2025-11-13T09:55:00Z",
          alertCount: 12,
          incidentCount: 1,
          tags: ["VPN", "Remote Access"],
          fullText:
            "Primary VPN gateway for remote users.\nLogs feed directly into SIEM.\n\nFrequent target for credential stuffing and brute force attacks.",
          notes: []
        }
      ]
    };

    // --- State & Storage ----------------------------------------------------
    const state = {
      activeTab: 'overview',
      selectedItem: null,
      data: {
        incidents: [],
        alerts: [],
        assets: []
      },
      notes: {
        perItem: {},
        perTab: {}
      },
      preferences: {
        theme: 'dark',
        lastTab: 'overview',
        analystName: 'Analyst'
      },
      filters: {
        incidents: { severity: 'all', status: 'all', search: '' },
        alerts: { severity: 'all', status: 'all', search: '' },
        assets: { criticality: 'all', search: '' }
      }
    };

    const Storage = {
      loadPreferences() {
        try {
          const raw = localStorage.getItem('socdash-preferences');
          return raw ? JSON.parse(raw) : {};
        } catch {
          return {};
        }
      },
      savePreferences(prefs) {
        try {
          localStorage.setItem('socdash-preferences', JSON.stringify(prefs));
        } catch {}
      },
      loadNotes() {
        try {
          const raw = localStorage.getItem('socdash-notes');
          if (!raw) return { perItem: {}, perTab: {} };
          const parsed = JSON.parse(raw);
          if (!parsed.perItem) parsed.perItem = {};
          if (!parsed.perTab) parsed.perTab = {};
          return parsed;
        } catch {
          return { perItem: {}, perTab: {} };
        }
      },
      saveNotes(notes) {
        try {
          localStorage.setItem('socdash-notes', JSON.stringify(notes));
        } catch {}
      }
    };

    // --- Init ---------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', init);

    function init() {
      state.data.incidents = DemoData.incidents;
      state.data.alerts = DemoData.alerts;
      state.data.assets = DemoData.assets;

      const savedPrefs = Storage.loadPreferences();
      Object.assign(state.preferences, savedPrefs);

      const savedNotes = Storage.loadNotes();
      if (savedNotes && savedNotes.perItem && savedNotes.perTab) {
        state.notes = savedNotes;
      }

      applyTheme(state.preferences.theme);

      renderOverview();
      renderIncidents();
      renderAlerts();
      renderAssets();
      renderSettings();

      setupTabNotes();
      bindTabEvents();
      bindDrawerEvents();
      bindDrawerTabEvents();
      bindSettingsEvents();
      bindFilterEvents();
      bindAddEvents();
      startClock();

      setActiveTab(state.preferences.lastTab || 'overview');
    }

    // --- General UI helpers -------------------------------------------------
    function setActiveTab(tabName) {
      state.activeTab = tabName;
      state.preferences.lastTab = tabName;
      Storage.savePreferences(state.preferences);

      document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.toggle('active', panel.id === 'tab-' + tabName);
      });
    }

    function applyTheme(theme) {
      const body = document.body;
      body.classList.remove('theme-dark', 'theme-light');
      if (theme === 'light') {
        body.classList.add('theme-light');
      } else {
        body.classList.add('theme-dark');
        theme = 'dark';
      }
      state.preferences.theme = theme;
      Storage.savePreferences(state.preferences);

      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) themeToggle.checked = theme === 'dark';
    }

    function bindTabEvents() {
      document.querySelectorAll('.tab').forEach(btn => {
        btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
      });
    }

    function startClock() {
      const el = document.getElementById('clock');
      if (!el) return;
      function update() {
        const now = new Date();
        el.textContent = now.toLocaleTimeString();
      }
      update();
      setInterval(update, 1000);
    }

    // --- Filters ------------------------------------------------------------
    function bindFilterEvents() {
      const iSev = document.getElementById('incident-filter-severity');
      const iStat = document.getElementById('incident-filter-status');
      const iSearch = document.getElementById('incident-filter-search');
      if (iSev) iSev.addEventListener('change', () => {
        state.filters.incidents.severity = iSev.value;
        renderIncidents();
        renderOverview();
      });
      if (iStat) iStat.addEventListener('change', () => {
        state.filters.incidents.status = iStat.value;
        renderIncidents();
        renderOverview();
      });
      if (iSearch) iSearch.addEventListener('input', () => {
        state.filters.incidents.search = iSearch.value;
        renderIncidents();
      });

      const aSev = document.getElementById('alert-filter-severity');
      const aStat = document.getElementById('alert-filter-status');
      const aSearch = document.getElementById('alert-filter-search');
      if (aSev) aSev.addEventListener('change', () => {
        state.filters.alerts.severity = aSev.value;
        renderAlerts();
        renderOverview();
      });
      if (aStat) aStat.addEventListener('change', () => {
        state.filters.alerts.status = aStat.value;
        renderAlerts();
      });
      if (aSearch) aSearch.addEventListener('input', () => {
        state.filters.alerts.search = aSearch.value;
        renderAlerts();
      });

      const asCrit = document.getElementById('asset-filter-criticality');
      const asSearch = document.getElementById('asset-filter-search');
      if (asCrit) asCrit.addEventListener('change', () => {
        state.filters.assets.criticality = asCrit.value;
        renderAssets();
      });
      if (asSearch) asSearch.addEventListener('input', () => {
        state.filters.assets.search = asSearch.value;
        renderAssets();
      });
    }

    function getFilteredIncidents() {
      const f = state.filters.incidents;
      return state.data.incidents.filter(inc => {
        if (f.severity !== 'all' && inc.severity !== f.severity) return false;
        if (f.status !== 'all' && inc.status !== f.status) return false;
        if (f.search) {
          const term = f.search.toLowerCase();
          const hay = (inc.id + ' ' + inc.title + ' ' + inc.owner + ' ' + inc.source).toLowerCase();
          if (!hay.includes(term)) return false;
        }
        return true;
      });
    }

    function getFilteredAlerts() {
      const f = state.filters.alerts;
      return state.data.alerts.filter(a => {
        if (f.severity !== 'all' && a.severity !== f.severity) return false;
        if (f.status !== 'all' && a.status !== f.status) return false;
        if (f.search) {
          const term = f.search.toLowerCase();
          const hay = (a.id + ' ' + a.rule + ' ' + a.source + ' ' + (a.assetId || '')).toLowerCase();
          if (!hay.includes(term)) return false;
        }
        return true;
      });
    }

    function getFilteredAssets() {
      const f = state.filters.assets;
      return state.data.assets.filter(as => {
        if (f.criticality !== 'all' && as.criticality !== f.criticality) return false;
        if (f.search) {
          const term = f.search.toLowerCase();
          const hay = (as.id + ' ' + as.hostname + ' ' + as.ip + ' ' + as.owner).toLowerCase();
          if (!hay.includes(term)) return false;
        }
        return true;
      });
    }

    // --- Overview Rendering -------------------------------------------------
    function renderOverview() {
      const incidents = state.data.incidents;
      const alerts = state.data.alerts;

      const openIncidents = incidents.filter(i => i.status !== 'Closed');
      const criticalOpen = openIncidents.filter(i => i.severity === 'Critical').length;
      const highOpen = openIncidents.filter(i => i.severity === 'High').length;
      const mediumOpen = openIncidents.filter(i => i.severity === 'Medium').length;
      const lowOpen = openIncidents.filter(i => i.severity === 'Low').length;

      const kpisEl = document.getElementById('overview-kpis');
      if (kpisEl) {
        kpisEl.innerHTML = `
          <div class="card kpi">
            <div class="kpi-label">Open Incidents</div>
            <div class="kpi-value">${openIncidents.length}</div>
            <div class="kpi-sub">Critical: ${criticalOpen}, High: ${highOpen}, Med: ${mediumOpen}, Low: ${lowOpen}</div>
          </div>
          <div class="card kpi">
            <div class="kpi-label">Total Alerts</div>
            <div class="kpi-value">${alerts.length}</div>
            <div class="kpi-sub">Current dataset</div>
          </div>
          <div class="card kpi">
            <div class="kpi-label">Assets with Alerts</div>
            <div class="kpi-value">${new Set(alerts.map(a => a.assetId)).size}</div>
            <div class="kpi-sub">From current dataset</div>
          </div>
        `;
      }

      const statusEl = document.getElementById('overall-status');
      if (statusEl) {
        statusEl.classList.remove('status-green', 'status-yellow', 'status-red');
        let statusClass = 'status-green';
        let text = 'Normal';
        if (criticalOpen > 0) {
          statusClass = 'status-red';
          text = 'Critical';
        } else if (highOpen > 0) {
          statusClass = 'status-yellow';
          text = 'Elevated';
        }
        statusEl.classList.add(statusClass);
        statusEl.textContent = text;
      }

      const tbody = document.getElementById('overview-alerts-tbody');
      if (tbody) {
        tbody.innerHTML = '';
        const sortedAlerts = [...alerts].sort((a, b) =>
          new Date(b.lastSeen || b.firstSeen) - new Date(a.lastSeen || a.firstSeen)
        );
        sortedAlerts.slice(0, 5).forEach(alert => {
          const tr = document.createElement('tr');
          tr.dataset.id = alert.id;
          tr.innerHTML = `
            <td>${alert.id}</td>
            <td>${escapeHtml(alert.rule)}</td>
            <td>${renderSeverityBadge(alert.severity)}</td>
            <td>${escapeHtml(alert.source)}</td>
            <td>${formatShortDate(alert.lastSeen || alert.firstSeen)}</td>
          `;
          tr.addEventListener('click', () => openDrawerForItem('alert', alert.id));
          tbody.appendChild(tr);
        });
      }
    }

    // --- Incidents / Alerts / Assets Rendering -----------------------------
    function renderIncidents() {
      const tbody = document.getElementById('incidents-tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      const incidents = getFilteredIncidents();
      incidents.forEach(incident => {
        const tr = document.createElement('tr');
        tr.dataset.id = incident.id;
        tr.innerHTML = `
          <td>${incident.id}</td>
          <td>${escapeHtml(incident.title)}</td>
          <td>${renderSeverityBadge(incident.severity)}</td>
          <td><span class="status-pill-small">${escapeHtml(incident.status)}</span></td>
          <td>${escapeHtml(incident.owner)}</td>
          <td>${escapeHtml(incident.source)}</td>
          <td>${formatShortDate(incident.createdAt)}</td>
          <td>
            <button class="btn btn-danger btn-small row-delete">Delete</button>
          </td>
        `;
        tr.addEventListener('click', (e) => {
          if (e.target && e.target.closest('.row-delete')) return;
          openDrawerForItem('incident', incident.id);
        });
        const delBtn = tr.querySelector('.row-delete');
        if (delBtn) {
          delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteItem('incident', incident.id);
          });
        }
        tbody.appendChild(tr);
      });
    }

    function renderAlerts() {
      const tbody = document.getElementById('alerts-tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      const alerts = getFilteredAlerts();
      alerts.forEach(alert => {
        const tr = document.createElement('tr');
        tr.dataset.id = alert.id;
        tr.innerHTML = `
          <td>${alert.id}</td>
          <td>${escapeHtml(alert.rule)}</td>
          <td>${renderSeverityBadge(alert.severity)}</td>
          <td><span class="status-pill-small">${escapeHtml(alert.status)}</span></td>
          <td>${escapeHtml(alert.source)}</td>
          <td>${escapeHtml(alert.assetId || "")}</td>
          <td>${formatShortDate(alert.lastSeen || alert.firstSeen)}</td>
          <td>
            <button class="btn btn-danger btn-small row-delete">Delete</button>
          </td>
        `;
        tr.addEventListener('click', (e) => {
          if (e.target && e.target.closest('.row-delete')) return;
          openDrawerForItem('alert', alert.id);
        });
        const delBtn = tr.querySelector('.row-delete');
        if (delBtn) {
          delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteItem('alert', alert.id);
          });
        }
        tbody.appendChild(tr);
      });
    }

    function renderAssets() {
      const tbody = document.getElementById('assets-tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      const assets = getFilteredAssets();
      assets.forEach(asset => {
        const tr = document.createElement('tr');
        tr.dataset.id = asset.id;
        tr.innerHTML = `
          <td>${asset.id}</td>
          <td>${escapeHtml(asset.hostname)}</td>
          <td>${escapeHtml(asset.ip)}</td>
          <td>${renderSeverityBadge(asset.criticality)}</td>
          <td>${escapeHtml(asset.owner)}</td>
          <td>${escapeHtml(asset.os)}</td>
          <td>${formatShortDate(asset.lastSeen)}</td>
          <td>
            <button class="btn btn-danger btn-small row-delete">Delete</button>
          </td>
        `;
        tr.addEventListener('click', (e) => {
          if (e.target && e.target.closest('.row-delete')) return;
          openDrawerForItem('asset', asset.id);
        });
        const delBtn = tr.querySelector('.row-delete');
        if (delBtn) {
          delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteItem('asset', asset.id);
          });
        }
        tbody.appendChild(tr);
      });
    }

    // --- Add Items ----------------------------------------------------------
    function bindAddEvents() {
      const addIncBtn = document.getElementById('add-incident-button');
      if (addIncBtn) addIncBtn.addEventListener('click', handleAddIncident);

      const addAltBtn = document.getElementById('add-alert-button');
      if (addAltBtn) addAltBtn.addEventListener('click', handleAddAlert);

      const addAsBtn = document.getElementById('add-asset-button');
      if (addAsBtn) addAsBtn.addEventListener('click', handleAddAsset);
    }

    function generateNextId(prefix, existingIds) {
      let maxNum = 0;
      existingIds.forEach(id => {
        if (id.startsWith(prefix + '-')) {
          const numPart = parseInt(id.split('-')[1], 10);
          if (!isNaN(numPart) && numPart > maxNum) maxNum = numPart;
        }
      });
      return prefix + '-' + (maxNum + 1);
    }

    function handleAddIncident() {
      const titleEl = document.getElementById('add-incident-title');
      const sevEl = document.getElementById('add-incident-severity');
      const statEl = document.getElementById('add-incident-status');
      const ownerEl = document.getElementById('add-incident-owner');
      const srcEl = document.getElementById('add-incident-source');
      const fullEl = document.getElementById('add-incident-fulltext');

      const title = titleEl.value.trim();
      if (!title) return;

      const nowIso = new Date().toISOString();
      const ids = state.data.incidents.map(i => i.id);
      const id = generateNextId('INC', ids);

      const incident = {
        id,
        title,
        severity: sevEl.value || 'High',
        status: statEl.value || 'New',
        owner: ownerEl.value.trim() || 'unassigned',
        source: srcEl.value.trim() || 'Manual',
        createdAt: nowIso,
        updatedAt: nowIso,
        tags: [],
        relatedAlerts: [],
        fullText: fullEl.value.trim() || 'No full text provided.',
        notes: []
      };

      state.data.incidents.push(incident);
      titleEl.value = '';
      ownerEl.value = '';
      srcEl.value = '';
      fullEl.value = '';

      renderIncidents();
      renderOverview();
    }

    function handleAddAlert() {
      const ruleEl = document.getElementById('add-alert-rule');
      const sevEl = document.getElementById('add-alert-severity');
      const statEl = document.getElementById('add-alert-status');
      const srcEl = document.getElementById('add-alert-source');
      const assetEl = document.getElementById('add-alert-asset');
      const fullEl = document.getElementById('add-alert-fulltext');

      const rule = ruleEl.value.trim();
      if (!rule) return;

      const nowIso = new Date().toISOString();
      const ids = state.data.alerts.map(a => a.id);
      const id = generateNextId('ALRT', ids);

      const alert = {
        id,
        rule,
        severity: sevEl.value || 'High',
        status: statEl.value || 'New',
        source: srcEl.value.trim() || 'Manual',
        firstSeen: nowIso,
        lastSeen: nowIso,
        count: 1,
        assetId: assetEl.value.trim() || '',
        incidentId: '',
        fullText: fullEl.value.trim() || 'No full text provided.',
        notes: []
      };

      state.data.alerts.push(alert);
      ruleEl.value = '';
      srcEl.value = '';
      assetEl.value = '';
      fullEl.value = '';

      renderAlerts();
      renderOverview();
    }

    function handleAddAsset() {
      const hostEl = document.getElementById('add-asset-hostname');
      const ipEl = document.getElementById('add-asset-ip');
      const critEl = document.getElementById('add-asset-criticality');
      const ownerEl = document.getElementById('add-asset-owner');
      const osEl = document.getElementById('add-asset-os');
      const fullEl = document.getElementById('add-asset-fulltext');

      const hostname = hostEl.value.trim();
      if (!hostname) return;

      const nowIso = new Date().toISOString();
      const ids = state.data.assets.map(a => a.id);
      const id = generateNextId('ASSET', ids);

      const asset = {
        id,
        hostname,
        ip: ipEl.value.trim() || '',
        owner: ownerEl.value.trim() || '',
        department: '',
        criticality: critEl.value || 'High',
        os: osEl.value.trim() || '',
        lastSeen: nowIso,
        alertCount: 0,
        incidentCount: 0,
        tags: [],
        fullText: fullEl.value.trim() || 'No full text provided.',
        notes: []
      };

      state.data.assets.push(asset);
      hostEl.value = '';
      ipEl.value = '';
      ownerEl.value = '';
      osEl.value = '';
      fullEl.value = '';

      renderAssets();
      renderOverview();
    }

    // --- Delete Items -------------------------------------------------------
    function deleteItem(type, id) {
      let arrKey = null;
      if (type === 'incident') arrKey = 'incidents';
      if (type === 'alert') arrKey = 'alerts';
      if (type === 'asset') arrKey = 'assets';
      if (!arrKey) return;

      const arr = state.data[arrKey];
      const idx = arr.findIndex(x => x.id === id);
      if (idx >= 0) arr.splice(idx, 1);

      const key = type + ':' + id;
      delete state.notes.perItem[key];
      Storage.saveNotes(state.notes);

      if (state.selectedItem && state.selectedItem.type === type && state.selectedItem.id === id) {
        closeDrawer();
      }

      if (type === 'incident') renderIncidents();
      if (type === 'alert') renderAlerts();
      if (type === 'asset') renderAssets();
      renderOverview();
    }

    // --- Tab Notes ----------------------------------------------------------
    function setupTabNotes() {
      document.querySelectorAll('.tab-notes-input').forEach(textarea => {
        const tab = textarea.dataset.tab;
        textarea.value = state.notes.perTab[tab] || '';
        textarea.addEventListener('input', () => {
          state.notes.perTab[tab] = textarea.value;
          Storage.saveNotes(state.notes);
        });
      });
    }

    // --- Drawer -------------------------------------------------------------
    function bindDrawerEvents() {
      const closeBtn = document.getElementById('drawer-close');
      if (closeBtn) closeBtn.addEventListener('click', closeDrawer);
    }

    function bindDrawerTabEvents() {
      const tabs = document.querySelectorAll('.drawer-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const target = tab.dataset.dtab;
          tabs.forEach(t => t.classList.toggle('active', t === tab));
          document.querySelectorAll('.drawer-panel').forEach(panel => {
            panel.classList.toggle('active', panel.id === 'drawer-' + target);
          });
        });
      });
    }

    function openDrawerForItem(type, id) {
      state.selectedItem = { type, id };
      const item = findItemById(type, id);
      if (!item) return;

      const key = type + ':' + id;
      const itemNotes = state.notes.perItem[key] || [];
      renderDrawer(item, type, itemNotes);

      const drawer = document.getElementById('detail-drawer');
      if (drawer) drawer.classList.add('open');
    }

    function closeDrawer() {
      const drawer = document.getElementById('detail-drawer');
      if (drawer) drawer.classList.remove('open');
      state.selectedItem = null;
    }

    function findItemById(type, id) {
      if (type === 'incident') return state.data.incidents.find(i => i.id === id);
      if (type === 'alert') return state.data.alerts.find(a => a.id === id);
      if (type === 'asset') return state.data.assets.find(a => a.id === id);
      return null;
    }

    function renderDrawer(item, type, notes) {
      const titleEl = document.getElementById('drawer-title');
      const metaEl = document.getElementById('drawer-meta');
      const summaryEl = document.getElementById('drawer-summary');
      const fullTextEl = document.getElementById('drawer-fulltext');

      if (titleEl) {
        let label = '';
        if (type === 'incident') label = 'Incident';
        if (type === 'alert') label = 'Alert';
        if (type === 'asset') label = 'Asset';
        titleEl.textContent = `${label} ${item.id}`;
      }

      if (metaEl) {
        const sev = item.severity || item.criticality;
        const severityHtml = sev ? renderSeverityBadge(sev) : '';
        const statusHtml = item.status ? `<span class="status-pill-small">${escapeHtml(item.status)}</span>` : '';
        metaEl.innerHTML = `
          ${severityHtml ? '<span>' + severityHtml + '</span>' : ''}
          ${statusHtml ? '<span>' + statusHtml + '</span>' : ''}
          ${item.owner ? '<span>Owner: ' + escapeHtml(item.owner) + '</span>' : ''}
          ${item.source ? '<span>Source: ' + escapeHtml(item.source) + '</span>' : ''}
        `;
      }

      if (summaryEl) {
        summaryEl.innerHTML = renderSummaryPanel(item, type);
      }

      if (fullTextEl) {
        const text = item.fullText || '(no full text available)';
        fullTextEl.innerHTML = `<pre class="fulltext">${escapeHtml(text)}</pre>`;
      }

      renderDrawerNotesPanel(notes);
    }

    function renderSummaryPanel(item, type) {
      const rows = [];
      const pushRow = (label, value) => {
        if (value === undefined || value === null || value === '') return;
        rows.push(`
          <div class="summary-row">
            <div class="summary-label">${label}</div>
            <div class="summary-value">${escapeHtml(String(value))}</div>
          </div>
        `);
      };

      if (type === 'incident') {
        pushRow('Title', item.title);
        pushRow('Severity', item.severity);
        pushRow('Status', item.status);
        pushRow('Owner', item.owner);
        pushRow('Source', item.source);
        pushRow('Created', formatFullDate(item.createdAt));
        pushRow('Updated', formatFullDate(item.updatedAt));
        pushRow('Tags', (item.tags || []).join(', '));
        pushRow('Related Alerts', (item.relatedAlerts || []).join(', '));
      } else if (type === 'alert') {
        pushRow('Rule', item.rule);
        pushRow('Severity', item.severity);
        pushRow('Status', item.status);
        pushRow('Source', item.source);
        pushRow('Asset ID', item.assetId);
        pushRow('Incident ID', item.incidentId || '');
        pushRow('First Seen', formatFullDate(item.firstSeen));
        pushRow('Last Seen', formatFullDate(item.lastSeen));
        pushRow('Count', item.count);
      } else if (type === 'asset') {
        pushRow('Hostname', item.hostname);
        pushRow('IP', item.ip);
        pushRow('Criticality', item.criticality);
        pushRow('Owner', item.owner);
        pushRow('Department', item.department);
        pushRow('OS', item.os);
        pushRow('Last Seen', formatFullDate(item.lastSeen));
        pushRow('Alert Count', item.alertCount);
        pushRow('Incident Count', item.incidentCount);
        pushRow('Tags', (item.tags || []).join(', '));
      }

      return `<div class="summary-grid">${rows.join('')}</div>`;
    }

    function renderDrawerNotesPanel(notes) {
      const notesEl = document.getElementById('drawer-notes');
      if (!notesEl) return;

      const itemsHtml = notes.map(note => `
        <div class="note-item">
          <div class="note-meta">${escapeHtml(note.author || 'Analyst')} Â· ${formatFullDate(note.createdAt)}</div>
          <div class="note-text">${escapeHtml(note.text)}</div>
        </div>
      `).join('');

      notesEl.innerHTML = `
        <div class="notes-list">
          ${itemsHtml || '<div style="font-size:0.8rem; opacity:0.7;">No notes yet.</div>'}
        </div>
        <div class="note-new">
          <textarea id="note-input" placeholder="Add a note for this item..."></textarea>
          <div style="margin-top:0.4rem; text-align:right;">
            <button id="add-note-button" class="btn btn-primary">Add Note</button>
          </div>
        </div>
      `;

      const btn = document.getElementById('add-note-button');
      const textarea = document.getElementById('note-input');
      if (btn && textarea) {
        btn.addEventListener('click', () => {
          const text = textarea.value.trim();
          if (!text || !state.selectedItem) return;
          addNoteForSelectedItem(text);
          textarea.value = '';
        });
      }
    }

    function addNoteForSelectedItem(text) {
      const sel = state.selectedItem;
      if (!sel) return;
      const key = sel.type + ':' + sel.id;
      const existing = state.notes.perItem[key] || [];

      const note = {
        id: 'note-' + Date.now(),
        author: state.preferences.analystName || 'Analyst',
        createdAt: new Date().toISOString(),
        text
      };

      const updated = [note, ...existing];
      state.notes.perItem[key] = updated;
      Storage.saveNotes(state.notes);
      renderDrawerNotesPanel(updated);
    }

    // --- Settings -----------------------------------------------------------
    function renderSettings() {
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) themeToggle.checked = state.preferences.theme === 'dark';
      const analystInput = document.getElementById('analyst-name-input');
      if (analystInput) analystInput.value = state.preferences.analystName || '';
    }

    function bindSettingsEvents() {
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.addEventListener('change', () => {
          applyTheme(themeToggle.checked ? 'dark' : 'light');
        });
      }

      const analystInput = document.getElementById('analyst-name-input');
      if (analystInput) {
        analystInput.addEventListener('input', () => {
          state.preferences.analystName = analystInput.value || 'Analyst';
          Storage.savePreferences(state.preferences);
        });
      }
    }

    // --- Utilities ----------------------------------------------------------
    function renderSeverityBadge(sev) {
      if (!sev) return '';
      const s = String(sev).toLowerCase();
      let cls = 'sev-low';
      if (s === 'critical') cls = 'sev-critical';
      else if (s === 'high') cls = 'sev-high';
      else if (s === 'medium') cls = 'sev-medium';
      return `<span class="badge ${cls}">${escapeHtml(sev)}</span>`;
    }

    function formatShortDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d.getTime())) return '';
      return d.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function formatFullDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d.getTime())) return '';
      return d.toLocaleString();
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>
</body>
</html>
